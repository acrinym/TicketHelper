<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NextNote V4 Fixed - With Quill</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <style>
    :root {
      --hermes-bg: #fff;
      --hermes-text: #333;
      --hermes-border: #ccc;
      --hermes-button-bg: #e9e9e9;
      --hermes-button-text: #333;
      --hermes-button-hover-bg: #dcdcdc;
      --hermes-panel-bg: #f4f4f4;
      --hermes-panel-text: #333;
      --hermes-panel-border: #ccc;
      --hermes-input-bg: #fff;
      --hermes-input-text: #333;
      --hermes-input-border: #ccc;
      --hermes-accent-bar-bg: #eee;
      --hermes-highlight-bg: #007bff;
      --hermes-highlight-text: #fff;
      --hermes-disabled-text: #aaa;
      --hermes-error-text: #dc3545;
      --hermes-success-text: #28a745;
      --hermes-warning-text: #ffc107;
      --hermes-info-text: #17a2b8;
      --hermes-link-color: #007bff;
      --hermes-link-hover-color: #0056b3;
    }
    body {
      display: flex; margin:0; height:100vh;
      background: var(--hermes-bg); color: var(--hermes-text);
      font-family: sans-serif;
    }
    #sidebar {
      width: 250px; background: var(--hermes-panel-bg);
      color: var(--hermes-panel-text); overflow-y:auto;
      border-right:1px solid var(--hermes-panel-border); padding:10px;
    }
    #main {
      flex:1; display:flex; flex-direction:column;
    }
    #toolbar {
      padding:10px; background:var(--hermes-panel-bg);
      border-bottom:1px solid var(--hermes-panel-border);
      display:flex; gap:5px; align-items:center; flex-wrap:wrap;
    }
    #editor { flex:1; display:flex; flex-direction: column; /* Changed to column for Quill toolbar/editor layout */ }
    /* Quill specific styling adjustments */
    #quillEditorContainer {
      flex:1; padding:10px; overflow:auto;
      background: var(--hermes-input-bg); color: var(--hermes-input-text);
      border:1px solid var(--hermes-input-border);
      /* This is important for Quill to take up available space */
      display: flex;
      flex-direction: column;
    }
    #quillEditorContainer .ql-container {
      flex: 1; /* Make the editor content itself fill the container */
      overflow-y: auto; /* Allow scrolling within the editor */
      border: none; /* Remove Quill's default border if not desired */
    }
    .ql-toolbar {
      border: 1px solid var(--hermes-panel-border);
      background: var(--hermes-accent-bar-bg);
      padding: 5px;
      margin-bottom: 5px; /* Add some space below the toolbar */
      border-radius: 4px;
    }
    .ql-container.ql-snow {
      border: 1px solid var(--hermes-input-border); /* Apply our border style to Quill's container */
      background: var(--hermes-input-bg);
      color: var(--hermes-input-text);
    }
    /* End Quill specific styling */

    #preview {
      flex:1; padding:10px; overflow:auto;
      border:1px solid var(--hermes-input-border);
      background: var(--hermes-input-bg); /* Use input background for consistency */
      color: var(--hermes-input-text);
    }
    button, select {
      background: var(--hermes-button-bg); color: var(--hermes-button-text);
      border:1px solid var(--hermes-border); padding:5px;
      cursor:pointer;
    }
    button:hover, select:hover {
      background: var(--hermes-button-hover-bg);
    }
    #sidebar button, #sidebar input {
      width:100%; margin-bottom:5px;
    }
    .section, .page-title {
      margin-bottom:5px; padding:5px;
    }
    .section {
      border:1px solid var(--hermes-panel-border);
    }
    .section-header {
      display:flex; justify-content:space-between; align-items:center;
      background: var(--hermes-accent-bar-bg); padding:5px;
    }
    .section-header span {
      font-weight:bold; cursor:pointer;
    }
    .pages {
      margin:5px 0 10px 10px; min-height:20px;
    }
    .page-title {
      display:flex; justify-content:space-between; 
      background:var(--hermes-input-bg); 
      border:1px solid var(--hermes-panel-border); cursor:pointer;
    }
    .page-title span {
      flex:1; padding:3px;
    }
    .delete-btn { background:none; border:none; color:var(--hermes-error-text); cursor:pointer; }
    .theme-select { margin-left:auto; }
  </style>
</head>
<body>
  <div id="sidebar">
    <h3>Sections</h3>
    <input id="newSectionInput" placeholder="New Section Name"/>
    <button onclick="addSection()">+ Add Section</button>
    <hr/>
    <div id="sections"></div>
  </div>
  <div id="main">
    <div id="toolbar">
      <span id="currentPageName">No Page Selected</span>
      <span id="pageMeta" style="margin-left:10px;color:var(--hermes-disabled-text);"></span>
      <button onclick="saveCurrentPage()">沈 Save</button>
      <button onclick="togglePreview()">早 Preview</button>
      <button onclick="document.getElementById('imgInput').click()">名 Image</button>
      <input type="file" id="imgInput" accept="image/*" style="display:none" onchange="insertImage(event)"/>
      <button onclick="exportMarkdown()">豆 Export MD</button>
      <input type="file" id="importFile" style="display:none" onchange="importMarkdown(event)"/>
      <button onclick="document.getElementById('importFile').click()">踏 Import MD</button>
      <div class="theme-select">
        <select id="themeSelect"></select>
      </div>
    </div>
    <div id="editor">
      <div id="quillEditorContainer"></div>
      <div id="preview" style="display:none;"></div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/turndown/dist/turndown.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <script>
    const hermesThemes = {
      light: `
        --hermes-bg:#f0f0f0;
        --hermes-text:#333;
        --hermes-border:#999;
        --hermes-button-bg:#e9e9e9;
        --hermes-button-text:#333;
        --hermes-button-hover-bg:#dcdcdc;
        --hermes-panel-bg:#fdfdfd;
        --hermes-panel-text:#333;
        --hermes-panel-border:#ccc;
        --hermes-input-bg:#fff;
        --hermes-input-text:#333;
        --hermes-input-border:#bbb;
        --hermes-accent-bar-bg:#d0d0d0;
        --hermes-highlight-bg:#007bff;
        --hermes-highlight-text:#fff;
        --hermes-disabled-text:#aaa;
        --hermes-error-text:#dc3545;
        --hermes-success-text:#28a745;
        --hermes-warning-text:#ffc107;
        --hermes-info-text:#17a2b8;
        --hermes-link-color:#007bff;
        --hermes-link-hover-color:#0056b3;
      `,
      dark: `
        --hermes-bg:#2c2c2c;
        --hermes-text:#e0e0e0;
        --hermes-border:#555;
        --hermes-button-bg:#484848;
        --hermes-button-text:#e0e0e0;
        --hermes-button-hover-bg:#585858;
        --hermes-panel-bg:#333;
        --hermes-panel-text:#e0e0e0;
        --hermes-panel-border:#444;
        --hermes-input-bg:#3a3a3a;
        --hermes-input-text:#e0e0e0;
        --hermes-input-border:#666;
        --hermes-accent-bar-bg:#1e1e1e;
        --hermes-highlight-bg:#007bff;
        --hermes-highlight-text:#fff;
        --hermes-disabled-text:#777;
        --hermes-error-text:#f5c6cb;
        --hermes-success-text:#c3e6cb;
        --hermes-warning-text:#ffeeba;
        --hermes-info-text:#bee5eb;
        --hermes-link-color:#6cb2eb;
        --hermes-link-hover-color:#3490dc;
      `,
      phoenix: `
        --hermes-bg:#fff3e0;
        --hermes-text:#4e342e;
        --hermes-border:#ff8f00;
        --hermes-button-bg:#ffcc80;
        --hermes-button-text:#4e342e;
        --hermes-button-hover-bg:#ffb74d;
        --hermes-panel-bg:#fff8e1;
        --hermes-panel-text:#4e342e;
        --hermes-panel-border:#ffd180;
        --hermes-input-bg:#fff;
        --hermes-input-text:#4e342e;
        --hermes-input-border:#ffc260;
        --hermes-accent-bar-bg:#ff6f00;
        --hermes-highlight-bg:#ff6f00;
        --hermes-highlight-text:#fff;
        --hermes-disabled-text:#aaa;
        --hermes-error-text:#dc3545;
        --hermes-success-text:#28a745;
        --hermes-warning-text:#ffc107;
        --hermes-info-text:#17a2b8;
        --hermes-link-color:#ff6f00;
        --hermes-link-hover-color:#e65c00;
      `
      // Add more themes as needed...
    };
    let sections = JSON.parse(localStorage.getItem("sections_v4")) || {};
    function migratePages(){
      const now = new Date().toISOString();
      Object.keys(sections).forEach(sec=>{
        sections[sec] = sections[sec].map(p=>({
          name: p.name,
          markdown: p.markdown||"",
          id: p.id || (crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).substring(2)),
          created: p.created || now,
          modified: p.modified || now
        }));
      });
    }
    let currentSection = null;
    let currentPage = null;
    let quill; // Declared global quill instance

    function saveToStorage(){
      localStorage.setItem("sections_v4", JSON.stringify(sections));
    }

    function renderSections(){
      const container = document.getElementById("sections");
      container.innerHTML="";
      Object.keys(sections).forEach(sec=>{
        const secDiv=document.createElement("div");
        secDiv.className="section";
        // header
        const header=document.createElement("div");
        header.className="section-header";
        const titleSpan=document.createElement("span");
        titleSpan.textContent=sec;
        titleSpan.onclick=()=>togglePages(secDiv);
        header.appendChild(titleSpan);
        const delBtn=document.createElement("button");
        delBtn.className="delete-btn"; delBtn.textContent="卵";
        delBtn.onclick=()=>{ delete sections[sec]; saveToStorage(); renderSections(); };
        header.appendChild(delBtn);
        secDiv.appendChild(header);
        // pages
        const pageList=document.createElement("div");
        pageList.className="pages";
        sections[sec].forEach((p,idx)=>{
          const pgDiv=document.createElement("div");
          pgDiv.className="page-title";
          const pgSpan=document.createElement("span");
          pgSpan.textContent=p.name;
          pgSpan.onclick=()=>loadPage(sec,idx);
          pgDiv.appendChild(pgSpan);
          const pgDel=document.createElement("button");
          pgDel.className="delete-btn"; pgDel.textContent="卵";
          pgDel.onclick=(e)=>{ e.stopPropagation(); sections[sec].splice(idx,1); saveToStorage(); renderSections(); };
          pgDiv.appendChild(pgDel);
          pageList.appendChild(pgDiv);
        });
        secDiv.appendChild(pageList);
        const addPgBtn=document.createElement("button");
        addPgBtn.textContent="+ Page";
        addPgBtn.onclick=()=>{
          const name=prompt("Page Name?");
          if(name){
            const now = new Date().toISOString();
            sections[sec].push({name,markdown:"",id:crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).substring(2),created:now,modified:now});
            saveToStorage();
            renderSections();
            loadPage(sec, sections[sec].length - 1);
          }
        };
        secDiv.appendChild(addPgBtn);
        container.appendChild(secDiv);
      });
      // Sortable
      Sortable.create(container,{animation:150, handle:".section-header", onEnd:saveData});
      document.querySelectorAll(".pages").forEach(pl=>{
        Sortable.create(pl,{animation:150,onUpdate:saveData});
      });
    }

    function togglePages(secDiv){
      const pages=secDiv.querySelector(".pages");
      pages.style.display = pages.style.display==="none"?"block":"none";
    }

    function addSection(){
      const name=document.getElementById("newSectionInput").value.trim();
      if(name&&!sections[name]){
        sections[name]=[]; saveToStorage(); renderSections(); document.getElementById("newSectionInput").value="";
      }
    }

    function loadPage(sec,idx){
      currentSection=sec; currentPage=idx;
      const page=sections[sec][idx];
      // Quill works best with HTML directly, so convert markdown first
      const htmlContent=marked.parse(page.markdown||"");
      quill.clipboard.dangerouslyPasteHTML(htmlContent); // Load HTML into Quill
      document.getElementById("currentPageName").textContent=sec+" > "+page.name;
      document.getElementById("pageMeta").textContent = `id: ${page.id} created: ${page.created} modified: ${page.modified}`;
      document.getElementById("preview").style.display="none";
      document.getElementById("quillEditorContainer").style.display="block"; // Show Quill editor
      quill.enable(true); // Ensure Quill is enabled
    }

    function saveCurrentPage(){
      if(currentSection!==null && currentPage!==null){
        const td=new TurndownService();
        // Get HTML content from Quill's editor root
        const html=quill.root.innerHTML;
        const page = sections[currentSection][currentPage];
        page.markdown = td.turndown(html);
        page.modified = new Date().toISOString();
        saveToStorage();
        document.getElementById("pageMeta").textContent = `id: ${page.id} created: ${page.created} modified: ${page.modified}`;
        renderMarkdown();
      }
    }

    function renderMarkdown(){
      if (currentSection !== null && currentPage !== null) { // Ensure a page is selected
        const raw=sections[currentSection][currentPage].markdown||"";
        document.getElementById("preview").innerHTML=marked.parse(raw);
      } else {
        document.getElementById("preview").innerHTML="<p>Select a page to see its preview.</p>";
      }
    }

    function togglePreview(){
      const ed=document.getElementById("quillEditorContainer");
      const pv=document.getElementById("preview");
      if(pv.style.display==="none"){
        saveCurrentPage(); // Save current Quill content before preview
        renderMarkdown();
        pv.style.display="block";
        ed.style.display="none";
        quill.enable(false); // Disable Quill editor when preview is active
      } else {
        pv.style.display="none";
        ed.style.display="block";
        quill.enable(true); // Enable Quill editor when switching back
      }
    }

    // Keep execCmd for potential future custom commands not handled by Quill
    function execCmd(cmd,val=null){
      // Quill handles most commands internally, but this function can be used for custom ones
      // document.execCommand(cmd,false,val); // This would bypass Quill's internal handling
      // For Quill-specific commands, use quill.format() or other Quill APIs
      // document.getElementById("quillEditorContainer").focus(); // Focus on Quill's editor
    }

    function insertImage(ev){
      const file=ev.target.files[0]; if(!file) return;
      const fr=new FileReader();
      fr.onload=e=>{
        const range = quill.getSelection(); // Get current cursor position
        if (range) {
          quill.insertEmbed(range.index, 'image', e.target.result);
        } else {
          quill.insertEmbed(quill.getLength(), 'image', e.target.result); // Insert at end if no selection
        }
      };
      fr.readAsDataURL(file);
    }

    function exportMarkdown(){
      if(currentSection===null||currentPage===null) return;
      const md=sections[currentSection][currentPage].markdown;
      const blob=new Blob([md],{type:"text/markdown"});
      const a=document.createElement("a");
      a.href=URL.createObjectURL(blob);
      a.download=sections[currentSection][currentPage].name.replace(/\s+/g,"_")+".md";
      a.click();
    }

    function importMarkdown(event){
      const file=event.target.files[0]; if(!file||currentSection===null||currentPage===null) return;
      const fr=new FileReader();
      fr.onload=e=>{ sections[currentSection][currentPage].markdown=e.target.result; saveToStorage(); loadPage(currentSection,currentPage); };
      fr.readAsText(file);
    }

    function saveData(){
      // reorder sections and pages into sections object
      const data={};
      document.querySelectorAll("#sections > .section").forEach(secDiv=>{
        const title=secDiv.querySelector(".section-header span").textContent;
        // Find the correct section from the original 'sections' object to preserve existing markdown
        const existingSectionPages = sections[title] || [];
        
        const newPagesOrder = [];
        secDiv.querySelectorAll(".page-title span").forEach(pgSpan => {
            const pageName = pgSpan.textContent;
            // Find the original page data with metadata
            const originalPage = existingSectionPages.find(p => p.name === pageName);
            if(originalPage){
              newPagesOrder.push(originalPage);
            } else {
              const now = new Date().toISOString();
              newPagesOrder.push({name: pageName, markdown: "", id: crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).substring(2), created: now, modified: now});
            }
        });
        data[title] = newPagesOrder;
      });
      sections=data; saveToStorage();
    }

    // Theme setup
    const themeSelect=document.getElementById("themeSelect");
    Object.keys(hermesThemes).forEach(name=>{
      const opt=document.createElement("option"); opt.value=name; opt.textContent=name; themeSelect.appendChild(opt);
    });
    themeSelect.onchange=()=>{
      document.documentElement.style.cssText=hermesThemes[themeSelect.value];
      localStorage.setItem("nextnote-theme", themeSelect.value); // Save selected theme
    };
    // Load
    window.onload=function(){
      migratePages();
      renderSections();
      // load theme
      const savedTheme=localStorage.getItem("nextnote-theme")||"light";
      themeSelect.value=savedTheme;
      document.documentElement.style.cssText=hermesThemes[savedTheme];

      // Initialize Quill
      quill = new Quill('#quillEditorContainer', {
        theme: 'snow', // Or 'bubble' for a floating tooltip
        modules: {
          toolbar: [
            [{ 'header': [1, 2, 3, 4, 5, 6, false] }], // Headings
            ['bold', 'italic', 'underline', 'strike'],        // Basic formatting
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],    // Lists
            [{ 'align': [] }],                               // Text alignment
            [{ 'color': [] }, { 'background': [] }],          // Text/background color
            ['link', 'image'],                       // Links, images (video is also available if needed)
            ['clean']                                         // Remove formatting
          ]
        }
      });

      // Initially, hide Quill until a page is selected
      document.getElementById("quillEditorContainer").style.display = "none";
      document.getElementById("preview").innerHTML = "<p>Select a page or create a new one to start writing.</p>";

      // Ensure that when saveData is called after drag/drop, markdown content is preserved.
      // Modified saveData to find and re-associate existing markdown.
    };
  </script>
</body>
</html>